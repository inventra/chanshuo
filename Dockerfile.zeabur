# ğŸ•ï¸ èŸ¬èªªéœ²ç‡Ÿå€ç®¡ç†ç³»çµ± - Zeaburå…¨æ£§éƒ¨ç½²
# Frontend + Backend in Single Container for Zeabur

# ==========================================
# éšæ®µ1: æ§‹å»ºReactå‰ç«¯
# ==========================================
FROM node:18-alpine AS frontend-builder

WORKDIR /frontend

# è¤‡è£½å‰ç«¯package.json
COPY front-end/hotel-dashboard/package*.json ./

# å®‰è£ä¾è³´ (åŒ…å«devDependenciesï¼ŒReactæ§‹å»ºéœ€è¦)
RUN npm ci --silent

# è¤‡è£½å‰ç«¯æºä»£ç¢¼
COPY front-end/hotel-dashboard/ ./

# è¨­ç½®å‰ç«¯ç’°å¢ƒè®Šé‡ (Zeaburç”Ÿç”¢ç’°å¢ƒ)
ENV NODE_ENV=production
ENV REACT_APP_API_URL=/api
ENV GENERATE_SOURCEMAP=false

# æ§‹å»ºå‰ç«¯
RUN npm run build

# ==========================================
# éšæ®µ2: Pythonå¾Œç«¯ç’°å¢ƒ
# ==========================================
FROM python:3.11.9-slim AS backend-builder

WORKDIR /backend

# å®‰è£ç·¨è­¯ä¾è³´
RUN apt-get update && apt-get install -y \
    gcc \
    g++ \
    && rm -rf /var/lib/apt/lists/*

# å®‰è£Pythonä¾è³´
COPY backend/requirements.txt ./
RUN pip install --no-cache-dir --upgrade pip && \
    pip install --no-cache-dir -r requirements.txt

# ==========================================
# éšæ®µ3: æœ€çµ‚é‹è¡Œç’°å¢ƒ
# ==========================================
FROM python:3.11.9-slim

# å®‰è£é‹è¡Œæ™‚ä¾è³´
RUN apt-get update && apt-get install -y \
    nginx \
    supervisor \
    curl \
    tzdata \
    && rm -rf /var/lib/apt/lists/* \
    && rm -f /etc/nginx/sites-enabled/default

# è¨­ç½®æ™‚å€
ENV TZ=Asia/Taipei
RUN ln -snf /usr/share/zoneinfo/$TZ /etc/localtime && echo $TZ > /etc/timezone

# è¤‡è£½Pythonç’°å¢ƒ
COPY --from=backend-builder /usr/local/lib/python3.11/site-packages/ /usr/local/lib/python3.11/site-packages/
COPY --from=backend-builder /usr/local/bin/ /usr/local/bin/

# è¨­ç½®å·¥ä½œç›®éŒ„
WORKDIR /app

# è¤‡è£½å¾Œç«¯ä»£ç¢¼
COPY backend/app/ ./backend/app/
COPY backend/database/ ./backend/database/
COPY backend/data/ ./backend/data/

# è¤‡è£½å‰ç«¯æ§‹å»ºæ–‡ä»¶
COPY --from=frontend-builder /frontend/build/ /var/www/html/

# è¤‡è£½é…ç½®æ–‡ä»¶
COPY nginx.zeabur.conf /etc/nginx/sites-available/default
COPY supervisord.conf /etc/supervisor/conf.d/supervisord.conf

# å‰µå»ºå¿…è¦ç›®éŒ„
RUN mkdir -p /app/logs /var/log/supervisor

# å‰µå»ºérootç”¨æˆ¶
RUN useradd --create-home --shell /bin/bash app_user && \
    chown -R app_user:app_user /app

# è¨­ç½®ç’°å¢ƒè®Šé‡
ENV PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1

# Zeaburæœƒè‡ªå‹•è¨­ç½®PORTç’°å¢ƒè®Šé‡ï¼Œæˆ‘å€‘éœ€è¦é©é…
RUN echo '#!/bin/bash\n\
set -e\n\
\n\
# è¨­ç½®é»˜èªç«¯å£\n\
export PORT=${PORT:-80}\n\
echo "ğŸš€ Starting Zeabur deployment on port $PORT"\n\
echo "ğŸŒ Zeabur assigned PORT: $PORT"\n\
\n\
# é¡¯ç¤ºç•¶å‰Nginxé…ç½®ä¸­çš„ç«¯å£\n\
echo "ğŸ“‹ Current Nginx config port:"\n\
grep "listen" /etc/nginx/sites-available/default || echo "No listen directive found"\n\
\n\
# æ›´æ–°Nginxé…ç½®ä¸­çš„ç«¯å£\n\
echo "ğŸ”§ Updating Nginx port from 80 to $PORT..."\n\
sed -i "s/listen 80;/listen $PORT;/" /etc/nginx/sites-available/default\n\
\n\
# ç¢ºèªç«¯å£ä¿®æ”¹æˆåŠŸ\n\
echo "âœ… Updated Nginx config port:"\n\
grep "listen" /etc/nginx/sites-available/default\n\
\n\
# æ¸¬è©¦Nginxé…ç½®èªæ³•\n\
echo "ğŸ§ª Testing Nginx configuration..."\n\
nginx -t || (echo "âŒ Nginx config test failed" && exit 1)\n\
echo "âœ… Nginx configuration is valid"\n\
\n\
# æ˜ å°„ Zeabur ç’°å¢ƒè®Šé‡åˆ°å¾Œç«¯æœŸæœ›çš„è®Šé‡å\n\
echo "ğŸ”§ Mapping Zeabur environment variables..."\n\
export DB_HOST="${ENV_DB_HOST:-localhost}"\n\
export DB_PORT="${ENV_DB_PORT:-5432}"\n\
export DB_USER="${ENV_DB_USER:-postgres}"\n\
export DB_PASSWORD="${ENV_DB_PASSWORD:-password}"\n\
export DB_NAME="${ENV_DB_NAME:-hotel_management}"\n\
export API_USERNAME="${ENV_API_USERNAME:-woorao}"\n\
export API_PASSWORD="${ENV_API_PASSWORD:-mz9k8czQHqnFt8Q}"\n\
export API_ECHO_TOKEN="${ENV_API_ECHO_TOKEN:-GD837Fjk3}"\n\
export API_HOTEL_CODE="${ENV_API_HOTEL_CODE:-2436}"\n\
export DEBUG="${ENV_DEBUG:-false}"\n\
export LOG_LEVEL="${ENV_LOG_LEVEL:-INFO}"\n\
\n\
echo "âœ… Environment variables mapped successfully"\n\
echo "ğŸ“ DB: $DB_HOST:$DB_PORT/$DB_NAME"\n\
echo "ğŸ‘¤ API User: $API_USERNAME"\n\
echo "ğŸ¨ Hotel Code: $API_HOTEL_CODE"\n\
echo "ğŸŒ Nginx will listen on: $PORT"\n\
echo "ğŸ FastAPI will run on: 127.0.0.1:8000"\n\
\n\
# å•Ÿå‹•supervisor\n\
echo "ğŸš€ Starting Supervisor with all services..."\n\
exec /usr/bin/supervisord -c /etc/supervisor/conf.d/supervisord.conf' > /start.sh && \
    chmod +x /start.sh

# æš´éœ²ç«¯å£ (Zeaburé€šå¸¸åˆ†é…8080)
EXPOSE 8080

# å¥åº·æª¢æŸ¥ (ä½¿ç”¨å‹•æ…‹ç«¯å£è…³æœ¬)
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
    CMD curl -f http://localhost:$(printenv PORT || echo 80)/health || exit 1

# å•Ÿå‹•å‘½ä»¤
CMD ["/start.sh"]
