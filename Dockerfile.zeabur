# ğŸ•ï¸ èŸ¬èªªéœ²ç‡Ÿå€ç®¡ç†ç³»çµ± - Zeaburå…¨æ£§éƒ¨ç½²
# Frontend + Backend in Single Container for Zeabur

# ==========================================
# éšæ®µ1: æ§‹å»ºReactå‰ç«¯
# ==========================================
FROM node:18-alpine AS frontend-builder

WORKDIR /frontend

# è¤‡è£½å‰ç«¯package.json
COPY front-end/hotel-dashboard/package*.json ./

# å®‰è£ä¾è³´
RUN npm ci --only=production --silent

# è¤‡è£½å‰ç«¯æºä»£ç¢¼
COPY front-end/hotel-dashboard/ ./

# è¨­ç½®å‰ç«¯ç’°å¢ƒè®Šé‡ (Zeaburç”Ÿç”¢ç’°å¢ƒ)
ENV NODE_ENV=production
ENV REACT_APP_API_URL=/api
ENV GENERATE_SOURCEMAP=false

# æ§‹å»ºå‰ç«¯
RUN npm run build

# ==========================================
# éšæ®µ2: Pythonå¾Œç«¯ç’°å¢ƒ
# ==========================================
FROM python:3.11.9-slim AS backend-builder

WORKDIR /backend

# å®‰è£ç·¨è­¯ä¾è³´
RUN apt-get update && apt-get install -y \
    gcc \
    g++ \
    && rm -rf /var/lib/apt/lists/*

# å®‰è£Pythonä¾è³´
COPY backend/requirements.txt ./
RUN pip install --no-cache-dir --upgrade pip && \
    pip install --no-cache-dir -r requirements.txt

# ==========================================
# éšæ®µ3: æœ€çµ‚é‹è¡Œç’°å¢ƒ
# ==========================================
FROM python:3.11.9-slim

# å®‰è£é‹è¡Œæ™‚ä¾è³´
RUN apt-get update && apt-get install -y \
    nginx \
    supervisor \
    curl \
    tzdata \
    && rm -rf /var/lib/apt/lists/* \
    && rm -f /etc/nginx/sites-enabled/default

# è¨­ç½®æ™‚å€
ENV TZ=Asia/Taipei
RUN ln -snf /usr/share/zoneinfo/$TZ /etc/localtime && echo $TZ > /etc/timezone

# è¤‡è£½Pythonç’°å¢ƒ
COPY --from=backend-builder /usr/local/lib/python3.11/site-packages/ /usr/local/lib/python3.11/site-packages/
COPY --from=backend-builder /usr/local/bin/ /usr/local/bin/

# è¨­ç½®å·¥ä½œç›®éŒ„
WORKDIR /app

# è¤‡è£½å¾Œç«¯ä»£ç¢¼
COPY backend/app/ ./backend/app/
COPY backend/database/ ./backend/database/
COPY backend/data/ ./backend/data/

# è¤‡è£½å‰ç«¯æ§‹å»ºæ–‡ä»¶
COPY --from=frontend-builder /frontend/build/ /var/www/html/

# è¤‡è£½é…ç½®æ–‡ä»¶
COPY nginx.zeabur.conf /etc/nginx/sites-available/default
COPY supervisord.conf /etc/supervisor/conf.d/supervisord.conf

# å‰µå»ºå¿…è¦ç›®éŒ„
RUN mkdir -p /app/logs /var/log/supervisor

# å‰µå»ºérootç”¨æˆ¶
RUN useradd --create-home --shell /bin/bash app_user && \
    chown -R app_user:app_user /app

# è¨­ç½®ç’°å¢ƒè®Šé‡
ENV PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1

# Zeaburæœƒè‡ªå‹•è¨­ç½®PORTç’°å¢ƒè®Šé‡ï¼Œæˆ‘å€‘éœ€è¦é©é…
RUN echo '#!/bin/bash\n\
# è¨­ç½®é»˜èªç«¯å£\n\
export PORT=${PORT:-80}\n\
echo "ğŸš€ Starting services on port $PORT"\n\
\n\
# æ›´æ–°Nginxé…ç½®ä¸­çš„ç«¯å£\n\
sed -i "s/listen 80;/listen $PORT;/" /etc/nginx/sites-available/default\n\
\n\
# ç¢ºä¿ç’°å¢ƒè®Šé‡å‚³éçµ¦supervisor\n\
export DATABASE_URL="${DATABASE_URL}"\n\
export API_HOTEL_CODE="${API_HOTEL_CODE}"\n\
export API_USERNAME="${API_USERNAME}"\n\
export API_PASSWORD="${API_PASSWORD}"\n\
export DEBUG="${DEBUG:-false}"\n\
export LOG_LEVEL="${LOG_LEVEL:-INFO}"\n\
\n\
# å•Ÿå‹•supervisor\n\
exec /usr/bin/supervisord -c /etc/supervisor/conf.d/supervisord.conf' > /start.sh && \
    chmod +x /start.sh

# æš´éœ²ç«¯å£ (Zeaburæœƒå‹•æ…‹åˆ†é…)
EXPOSE 80

# å¥åº·æª¢æŸ¥
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
    CMD curl -f http://localhost:${PORT:-80}/health || exit 1

# å•Ÿå‹•å‘½ä»¤
CMD ["/start.sh"]
