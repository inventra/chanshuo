# 🏕️ 蟬說露營區管理系統 - Zeabur全棧部署
# Frontend + Backend in Single Container for Zeabur
# Build Version: 2025-09-17-403-fix - 強制重建解決權限問題

# ==========================================
# 階段1: 構建React前端
# ==========================================
FROM node:18-alpine AS frontend-builder

WORKDIR /frontend

# 複製前端package.json
COPY front-end/hotel-dashboard/package*.json ./

# 安裝依賴 (包含devDependencies，React構建需要)
RUN npm ci --silent

# 複製前端源代碼
COPY front-end/hotel-dashboard/ ./

# 設置前端環境變量 (Zeabur生產環境)
ENV NODE_ENV=production
ENV REACT_APP_API_URL=/api
ENV GENERATE_SOURCEMAP=false

# 構建前端
RUN npm run build

# ==========================================
# 階段2: Python後端環境
# ==========================================
FROM python:3.11.9-slim AS backend-builder

WORKDIR /backend

# 安裝編譯依賴
RUN apt-get update && apt-get install -y \
    gcc \
    g++ \
    && rm -rf /var/lib/apt/lists/*

# 安裝Python依賴
COPY backend/requirements.txt ./
RUN pip install --no-cache-dir --upgrade pip && \
    pip install --no-cache-dir -r requirements.txt

# ==========================================
# 階段3: 最終運行環境
# ==========================================
FROM python:3.11.9-slim

# 安裝運行時依賴
RUN apt-get update && apt-get install -y \
    nginx \
    supervisor \
    curl \
    tzdata \
    && rm -rf /var/lib/apt/lists/* \
    && rm -f /etc/nginx/sites-enabled/default

# 設置時區
ENV TZ=Asia/Taipei
RUN ln -snf /usr/share/zoneinfo/$TZ /etc/localtime && echo $TZ > /etc/timezone

# 複製Python環境
COPY --from=backend-builder /usr/local/lib/python3.11/site-packages/ /usr/local/lib/python3.11/site-packages/
COPY --from=backend-builder /usr/local/bin/ /usr/local/bin/

# 設置工作目錄
WORKDIR /app

# 複製後端代碼
COPY backend/app/ ./backend/app/
COPY backend/database/ ./backend/database/
COPY backend/data/ ./backend/data/

# 複製前端構建文件
COPY --from=frontend-builder /frontend/build/ /var/www/html/

# 複製配置文件
COPY nginx.zeabur.conf /etc/nginx/sites-available/default
COPY supervisord.conf /etc/supervisor/conf.d/supervisord.conf

# 創建必要目錄和設置權限
RUN mkdir -p /app/logs /var/log/supervisor && \
    chmod -R 755 /var/www/html && \
    chown -R www-data:www-data /var/www/html

# 創建非root用戶
RUN useradd --create-home --shell /bin/bash app_user && \
    chown -R app_user:app_user /app

# 設置環境變量
ENV PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1

# 簡化的Zeabur啟動腳本 - 固定使用8080端口
RUN echo '#!/bin/bash\n\
set -e\n\
\n\
echo "🚀 Starting 蟬說露營區管理系統 on Zeabur"\n\
echo "🌐 Nginx listening on: 8080 (fixed)"\n\
echo "🐍 FastAPI running on: 127.0.0.1:8000"\n\
\n\
# 測試Nginx配置語法\n\
echo "🧪 Testing Nginx configuration..."\n\
nginx -t || (echo "❌ Nginx config test failed" && exit 1)\n\
echo "✅ Nginx configuration is valid"\n\
\n\
# 映射 Zeabur 環境變量到後端期望的變量名\n\
echo "🔧 Mapping Zeabur environment variables..."\n\
export DB_HOST="${ENV_DB_HOST:-localhost}"\n\
export DB_PORT="${ENV_DB_PORT:-5432}"\n\
export DB_USER="${ENV_DB_USER:-postgres}"\n\
export DB_PASSWORD="${ENV_DB_PASSWORD:-password}"\n\
export DB_NAME="${ENV_DB_NAME:-hotel_management}"\n\
export API_USERNAME="${ENV_API_USERNAME:-woorao}"\n\
export API_PASSWORD="${ENV_API_PASSWORD:-mz9k8czQHqnFt8Q}"\n\
export API_ECHO_TOKEN="${ENV_API_ECHO_TOKEN:-GD837Fjk3}"\n\
export API_HOTEL_CODE="${ENV_API_HOTEL_CODE:-2436}"\n\
export DEBUG="${ENV_DEBUG:-false}"\n\
export LOG_LEVEL="${ENV_LOG_LEVEL:-INFO}"\n\
\n\
echo "✅ Environment variables mapped successfully"\n\
echo "📍 DB: $DB_HOST:$DB_PORT/$DB_NAME"\n\
echo "👤 API User: $API_USERNAME"\n\
echo "🏨 Hotel Code: $API_HOTEL_CODE"\n\
\n\
# 強制設置前端文件權限 (解決403問題)\n\
echo "🔧 Setting up frontend file permissions..."\n\
chmod -R 755 /var/www/html\n\
chown -R www-data:www-data /var/www/html\n\
ls -la /var/www/html/index.html || echo "⚠️ index.html not found"\n\
echo "✅ Frontend permissions set: $(ls -ld /var/www/html)"\n\
\n\
# 測試前端文件可讀性\n\
echo "🧪 Testing frontend file accessibility..."\n\
test -r /var/www/html/index.html && echo "✅ index.html is readable" || echo "❌ index.html is not readable"\n\
\n\
# 啟動supervisor\n\
echo "🚀 Starting Supervisor with all services..."\n\
exec /usr/bin/supervisord -c /etc/supervisor/conf.d/supervisord.conf' > /start.sh && \
    chmod +x /start.sh

# 暴露端口 (Zeabur通常分配8080)
EXPOSE 8080

# 健康檢查 (固定8080端口)
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
    CMD curl -f http://localhost:8080/health || exit 1

# 啟動命令
CMD ["/start.sh"]
