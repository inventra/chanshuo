# ğŸ•ï¸ èŸ¬èªªéœ²ç‡Ÿå€ç®¡ç†ç³»çµ± - å…¨æ£§Dockeré…ç½®
# Frontend + Backend in Single Container

# ==========================================
# éšæ®µ1: æ§‹å»ºReactå‰ç«¯
# ==========================================
FROM node:18-alpine AS frontend-builder

WORKDIR /frontend

# è¤‡è£½å‰ç«¯ä»£ç¢¼
COPY front-end/hotel-dashboard/package*.json ./
RUN npm ci --only=production

COPY front-end/hotel-dashboard/ ./

# è¨­ç½®å‰ç«¯ç’°å¢ƒè®Šé‡
ENV REACT_APP_API_URL=
ENV GENERATE_SOURCEMAP=false

# æ§‹å»ºå‰ç«¯éœæ…‹æ–‡ä»¶
RUN npm run build

# ==========================================
# éšæ®µ2: è¨­ç½®Pythonå¾Œç«¯
# ==========================================
FROM python:3.11.9-slim AS backend-setup

WORKDIR /backend

# å®‰è£ç³»çµ±ä¾è³´
RUN apt-get update && apt-get install -y \
    gcc \
    g++ \
    curl \
    && rm -rf /var/lib/apt/lists/*

# è¤‡è£½ä¸¦å®‰è£Pythonä¾è³´
COPY backend/requirements.txt ./
RUN pip install --no-cache-dir --upgrade pip && \
    pip install --no-cache-dir -r requirements.txt

# è¤‡è£½å¾Œç«¯ä»£ç¢¼
COPY backend/app/ ./app/
COPY backend/database/ ./database/
COPY backend/data/ ./data/

# ==========================================
# éšæ®µ3: æœ€çµ‚é‹è¡Œç’°å¢ƒ - Nginx + Python
# ==========================================
FROM python:3.11.9-slim

# å®‰è£Nginxã€Supervisorå’Œå…¶ä»–å¿…è¦å·¥å…·
RUN apt-get update && apt-get install -y \
    nginx \
    supervisor \
    curl \
    tzdata \
    && rm -rf /var/lib/apt/lists/*

# è¨­ç½®æ™‚å€
ENV TZ=Asia/Taipei
RUN ln -snf /usr/share/zoneinfo/$TZ /etc/localtime && echo $TZ > /etc/timezone

# å‰µå»ºæ‡‰ç”¨ç›®éŒ„
WORKDIR /app

# å¾backend-setupéšæ®µè¤‡è£½Pythonç’°å¢ƒå’Œä»£ç¢¼
COPY --from=backend-setup /usr/local/lib/python3.11/site-packages/ /usr/local/lib/python3.11/site-packages/
COPY --from=backend-setup /usr/local/bin/ /usr/local/bin/
COPY --from=backend-setup /backend/ ./backend/

# å¾frontend-builderéšæ®µè¤‡è£½æ§‹å»ºçš„å‰ç«¯æ–‡ä»¶
COPY --from=frontend-builder /frontend/build/ /var/www/html/

# å‰µå»ºNginxé…ç½®
RUN rm -f /etc/nginx/sites-enabled/default
COPY nginx.conf /etc/nginx/sites-available/chanshuo
RUN ln -s /etc/nginx/sites-available/chanshuo /etc/nginx/sites-enabled/

# å‰µå»ºSupervisoré…ç½®
COPY supervisord.conf /etc/supervisor/conf.d/supervisord.conf

# å‰µå»ºæ—¥èªŒç›®éŒ„
RUN mkdir -p /app/logs /var/log/supervisor

# å‰µå»ºérootç”¨æˆ¶
RUN useradd --create-home --shell /bin/bash app_user && \
    chown -R app_user:app_user /app && \
    chown -R app_user:app_user /var/www/html

# è¨­ç½®ç’°å¢ƒè®Šé‡
ENV PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1 \
    PORT=8000

# æš´éœ²ç«¯å£
EXPOSE 80

# å¥åº·æª¢æŸ¥
HEALTHCHECK --interval=30s --timeout=10s --start-period=40s --retries=3 \
    CMD curl -f http://localhost/api/health || exit 1

# å•Ÿå‹•å‘½ä»¤ - ä½¿ç”¨Supervisorç®¡ç†Nginxå’ŒPython
CMD ["/usr/bin/supervisord", "-c", "/etc/supervisor/conf.d/supervisord.conf"]
